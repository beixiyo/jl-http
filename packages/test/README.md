# jl-http 完整测试文档

这是 `@jl-org/http` 包的完整测试系统，包含两种测试方式：**Web页面真实测试** 和 **Vitest自动化测试**。

## 📋 测试概述

本测试系统提供了全面的测试覆盖，确保 jl-http 包的功能稳定性和代码质量：

- **Web页面测试**: 通过浏览器界面进行的功能演示和真实测试
- **Vitest单元测试**: 自动化的单元测试、集成测试和CLI工具测试
- **测试覆盖率**: 85%+ 全局覆盖率，95%+ 核心模块覆盖率

## 🚀 快速开始

### 1. Web页面测试

```bash
# 在项目根目录
cd packages/test
pnpm dev
```

项目将在 `http://localhost:5173` 启动（默认端口）。

### 2. Vitest自动化测试

```bash
# 运行所有测试
pnpm test

# 运行测试并生成覆盖率报告
pnpm test:coverage

# 监听模式运行测试
pnpm test:watch

# 使用 UI 界面运行测试
pnpm test:ui
```

## 🌐 Web页面测试说明

Web页面测试提供了直观的界面来演示和测试 jl-http 的各项功能：

### 1. HTTP 基础功能测试 (`/http-basic`)
- **功能**: 测试基础的 HTTP 请求方法（GET、POST、PUT、DELETE）
- **特性**: 支持多种 HTTP 方法、灵活配置选项、自动错误处理、拦截器支持
- **测试内容**: 不同 HTTP 方法的请求、请求参数配置、响应类型处理、错误处理机制

### 2. 请求缓存功能测试 (`/http-cache`)
- **功能**: 测试请求缓存机制
- **特性**: 内存缓存、参数隔离、自动清理、缓存命中检测
- **测试内容**: 缓存命中效果、缓存超时机制、不同参数的缓存隔离、缓存性能对比

### 3. 请求重试功能测试 (`/http-retry`)
- **功能**: 测试请求重试机制
- **特性**: 智能重试、可配置重试次数、重试策略、详细日志记录
- **测试内容**: 服务器错误重试、网关超时重试、客户端错误不重试验证、重试过程跟踪

### 4. 请求中断功能测试 (`/http-abort`)
- **功能**: 测试请求中断控制
- **特性**: 手动中断、超时中断、信号控制、批量中断
- **测试内容**: 手动中断请求、超时自动中断、并发请求批量中断、中断状态跟踪

### 5. 并发请求功能测试 (`/http-concurrent`)
- **功能**: 测试并发请求处理
- **特性**: 并发控制、顺序保持、错误隔离、自动调度
- **测试内容**: 并发任务执行、结果聚合、错误处理、性能监控

### 6. SSE 流式数据测试 (`/http-sse`)
- **功能**: 测试 SSE 流式数据处理
- **特性**: 实时数据流、数据解析、JSON 解析、连接管理
- **测试内容**: 实时数据接收、数据格式解析、连接状态管理、错误处理

### 7. 拦截器功能测试 (`/http-interceptors`)
- **功能**: 测试请求和响应拦截器
- **特性**: 请求拦截器、响应拦截器、错误拦截器、链式处理
- **测试内容**: 请求预处理、响应后处理、错误拦截、拦截器配置

### 8. 综合功能演示 (`/http-comprehensive`)
- **功能**: 展示多个功能组合使用的场景
- **特性**: 组合功能使用、业务流程模拟、完整的使用示例、性能监控
- **测试内容**: 基础 CRUD 操作流程、缓存机制演示、并发请求处理、请求中断控制、复杂业务流程

## 🧪 Vitest自动化测试说明

### 测试结构

```
test/
├── core/                 # 核心功能测试
│   ├── BaseReq.test.ts   # 基础请求类测试
│   └── Http.test.ts      # HTTP 缓存类测试
├── tools/                # 工具函数测试
│   ├── tool.test.ts      # 基础工具函数测试
│   ├── retryTask.test.ts # 重试机制测试
│   ├── concurrentTask.test.ts # 并发任务测试
│   ├── SSEStreamProcessor.test.ts # SSE 流处理测试
│   └── defineConfig.test.ts # 配置定义测试
├── cli/                  # CLI 工具测试
│   ├── esmTocjs.test.ts  # ES6 到 CommonJS 转换测试
│   └── genType.test.ts   # 类型生成测试
├── integration/          # 集成测试
│   ├── http-integration.test.ts # HTTP 功能集成测试
│   └── sse-integration.test.ts  # SSE 功能集成测试
├── setup.ts             # 测试环境设置
└── README.md            # 测试详细文档
```

### 测试命令

```bash
# 基本测试命令
pnpm test                 # 运行所有测试
pnpm test:watch          # 监听模式运行测试
pnpm test:coverage       # 运行测试并生成覆盖率报告
pnpm test:report         # 运行测试并生成完整报告
pnpm test:ui             # 使用 UI 界面运行测试

# 分类测试
pnpm test:unit           # 只运行单元测试
pnpm test:integration    # 只运行集成测试
pnpm test:cli            # 只运行 CLI 测试
pnpm test:all            # 运行所有测试（分步骤）

# 特定测试
pnpm vitest run test/core/BaseReq.test.ts  # 运行特定文件的测试
pnpm vitest run --grep "缓存"              # 运行匹配模式的测试
```

### 测试覆盖率目标

- **全局覆盖率**: 85% (语句、函数、行数)，80% (分支)
- **核心模块**: 95% (语句、函数、行数)，90% (分支)
- **工具模块**: 90% (语句、函数、行数)，85% (分支)

### 测试类型

1. **单元测试**: 测试单个函数或类的功能
   - BaseReq: HTTP 请求基础功能
   - Http: 缓存功能
   - 工具函数: 类型检测、深度比较、等待函数等
   - 重试机制: 失败重试逻辑
   - 并发任务: 并发执行控制
   - SSE 流处理: 服务器发送事件处理

2. **集成测试**: 测试多个模块协同工作
   - HTTP + 缓存 + 重试: 完整请求流程
   - SSE + BaseReq: 流数据处理
   - 并发 + 缓存: 并发请求缓存
   - 拦截器集成: 请求/响应拦截器与其他功能的配合

3. **CLI 测试**: 测试命令行工具功能
   - 代码转换: ES6 到 CommonJS 转换
   - 类型生成: TypeScript 类型生成
   - 配置解析: 配置文件处理

## 💡 使用建议

### Web页面测试
1. **从基础开始**: 建议先查看 "HTTP 基础功能测试" 了解基本用法
2. **逐步深入**: 按照菜单顺序逐个测试各项功能
3. **综合应用**: 最后查看 "综合功能演示" 了解实际应用场景
4. **实时监控**: 打开浏览器开发者工具查看网络请求和控制台日志
5. **交互测试**: 尝试修改配置参数，观察不同配置下的行为差异

### Vitest自动化测试
1. **开发时**: 使用 `pnpm test:watch` 进行实时测试
2. **提交前**: 运行 `pnpm test:coverage` 确保覆盖率达标
3. **调试**: 使用 `pnpm test:ui` 进行可视化调试
4. **CI/CD**: 使用 `pnpm test:report` 生成完整报告

## 🛠️ 技术栈

- **前端框架**: React 18 + TypeScript
- **样式**: UnoCSS (兼容 TailwindCSS)
- **路由**: React Router v6
- **动画**: Framer Motion
- **图标**: Lucide React
- **HTTP 库**: @jl-org/http (被测试的库)
- **测试框架**: Vitest + jsdom
- **覆盖率**: @vitest/coverage-v8

## ⚠️ 注意事项

### Web页面测试
1. 某些测试需要网络连接，请确保网络畅通
2. SSE 测试可能需要支持 SSE 的服务端点
3. 部分测试使用了公共 API（如 jsonplaceholder.typicode.com），可能会有访问限制
4. 建议在现代浏览器中测试，以获得最佳体验

### Vitest测试
1. 测试使用了 mock 环境，不需要真实网络连接
2. 某些集成测试可能需要较长时间，请耐心等待
3. 如果测试失败，请检查 Node.js 版本是否符合要求
4. 覆盖率报告生成在 `coverage/` 目录下

## 🔧 开发说明

### 添加Web测试页面
1. 在 `src/views/` 目录下创建新的子目录
2. 在子目录中创建 `index.tsx` 文件
3. 路由系统会自动扫描并生成对应路由
4. 在 `src/components/Menu/index.tsx` 中添加导航链接

### 添加Vitest测试
1. 在 `test/` 对应目录下创建 `*.test.ts` 文件
2. 遵循 AAA 模式: Arrange (准备) → Act (执行) → Assert (断言)
3. 使用描述性的测试名称
4. 确保测试独立性，不依赖其他测试

## 📞 反馈

如果在测试过程中发现问题或有改进建议，请提交 Issue 或 Pull Request。
